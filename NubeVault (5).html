<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!-- PWA Manifest -->
<!-- manifest disabled for standalone HTML -->
<meta name="theme-color" content="#0a0b0f">
<meta name="mobile-web-app-capable" content="yes">
<meta name="description" content="Tu nube personal privada">
<!-- iOS Safari PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NubeVault">
<link rel="apple-touch-icon" href="logo-tipo-transparencia.png">
<link rel="icon" type="image/svg+xml" href="logo-tipo-transparencia.png">
<link rel="shortcut icon" href="logo-tipo-transparencia.png">
<meta name="application-name" content="NubeVault">
<title>ELITE</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0b0f;
    --panel: #111318;
    --panel2: #181b22;
    --border: #1f2330;
    --accent: #4f8cff;
    --accent2: #a259ff;
    --green: #22d3a5;
    --red: #ff4f6a;
    --yellow: #ffc84a;
    --text: #e8eaf0;
    --muted: #6b7285;
    --glow: 0 0 40px rgba(79,140,255,0.18);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ===== PARTICLES BG ===== */
  #particles { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
  .particle {
    position: absolute;
    border-radius: 50%;
    animation: float linear infinite;
    opacity: 0;
  }
  @keyframes float {
    0% { transform: translateY(100vh) scale(0); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
  }

  /* ===== AUTH SCREEN ===== */
  #auth-screen {
    position: fixed; inset: 0; z-index: 100;
    display: flex; align-items: center; justify-content: center;
    background: radial-gradient(ellipse at 60% 30%, #0d1a3a 0%, #0a0b0f 60%);
  }
  .auth-container {
    width: 100%; max-width: 440px; padding: 20px;
    animation: slideUp 0.7s cubic-bezier(.22,1,.36,1) both;
  }
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(40px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .auth-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 44px 40px;
    box-shadow: var(--glow), 0 40px 80px rgba(0,0,0,0.6);
    position: relative;
    overflow: hidden;
  }
  .auth-card::before {
    content: '';
    position: absolute; top: -80px; right: -80px;
    width: 200px; height: 200px;
    background: radial-gradient(circle, rgba(79,140,255,0.15) 0%, transparent 70%);
    border-radius: 50%;
  }
  .auth-card::after {
    content: '';
    position: absolute; bottom: -60px; left: -60px;
    width: 160px; height: 160px;
    background: radial-gradient(circle, rgba(162,89,255,0.12) 0%, transparent 70%);
    border-radius: 50%;
  }
  .auth-logo {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 32px;
  }
  .auth-logo-icon {
    width: 46px; height: 46px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    box-shadow: 0 4px 20px rgba(79,140,255,0.4);
  }
  .auth-logo-text { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 800; }
  .auth-logo-text span { color: var(--accent); }

  .auth-tabs {
    display: flex; gap: 4px;
    background: var(--panel2);
    padding: 4px;
    border-radius: 12px;
    margin-bottom: 28px;
  }
  .auth-tab {
    flex: 1; padding: 10px;
    background: none; border: none;
    color: var(--muted); font-family: 'DM Sans', sans-serif;
    font-size: 14px; font-weight: 500;
    border-radius: 9px; cursor: pointer;
    transition: all 0.25s;
  }
  .auth-tab.active {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 2px 12px rgba(79,140,255,0.4);
  }

  .form-group { margin-bottom: 18px; position: relative; }
  .form-group label {
    display: block; font-size: 12px; font-weight: 500;
    color: var(--muted); margin-bottom: 7px; letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .form-group input {
    width: 100%; padding: 13px 16px 13px 44px;
    background: var(--panel2);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 15px;
    outline: none; transition: all 0.25s;
  }
  .form-group input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(79,140,255,0.15);
  }
  .form-group .icon {
    position: absolute; left: 14px; top: 38px;
    color: var(--muted); font-size: 17px;
  }
  .form-group .toggle-pass {
    position: absolute; right: 14px; top: 38px;
    color: var(--muted); cursor: pointer; font-size: 17px;
    background: none; border: none;
  }

  .strength-bar {
    display: flex; gap: 4px; margin-top: 8px;
  }
  .strength-bar div {
    height: 3px; flex: 1; border-radius: 99px;
    background: var(--border); transition: background 0.3s;
  }

  .auth-btn {
    width: 100%; padding: 14px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none; border-radius: 12px;
    color: #fff; font-family: 'Syne', sans-serif;
    font-size: 16px; font-weight: 700;
    cursor: pointer; margin-top: 8px;
    transition: all 0.25s;
    position: relative; overflow: hidden;
    letter-spacing: 0.3px;
  }
  .auth-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 30px rgba(79,140,255,0.4); }
  .auth-btn:active { transform: translateY(0); }
  .auth-btn .btn-ripple {
    position: absolute; border-radius: 50%;
    background: rgba(255,255,255,0.3);
    transform: scale(0);
    animation: ripple 0.6s linear;
    pointer-events: none;
  }
  @keyframes ripple {
    to { transform: scale(4); opacity: 0; }
  }

  .auth-divider {
    text-align: center; color: var(--muted); font-size: 12px;
    margin: 20px 0; position: relative;
  }
  .auth-divider::before, .auth-divider::after {
    content: ''; position: absolute; top: 50%; width: 40%;
    height: 1px; background: var(--border);
  }
  .auth-divider::before { left: 0; }
  .auth-divider::after { right: 0; }

  .auth-error {
    background: rgba(255,79,106,0.1);
    border: 1px solid rgba(255,79,106,0.3);
    border-radius: 10px; padding: 10px 14px;
    font-size: 13px; color: var(--red);
    margin-bottom: 16px; display: none;
    animation: shake 0.4s ease;
  }
  @keyframes shake {
    0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 60%{transform:translateX(6px)}
  }

  /* ===== APP SCREEN ===== */
  #app-screen { display: none; min-height: 100vh; position: relative; z-index: 10; }

  /* HEADER */
  .header {
    position: sticky; top: 0; z-index: 50;
    background: rgba(10,11,15,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 64px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .header-logo {
    font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800;
    display: flex; align-items: center; gap: 10px;
  }
  .header-logo-icon {
    width: 34px; height: 34px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 9px; display: flex; align-items: center; justify-content: center;
    font-size: 16px;
  }
  .header-logo span { color: var(--accent); }
  .header-right { display: flex; align-items: center; gap: 16px; }
  .search-bar {
    display: flex; align-items: center; gap: 8px;
    background: var(--panel2);
    border: 1px solid var(--border);
    border-radius: 10px; padding: 8px 14px;
    width: 260px; transition: all 0.25s;
  }
  .search-bar:focus-within { border-color: var(--accent); width: 300px; }
  .search-bar input {
    background: none; border: none; color: var(--text);
    font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none; width: 100%;
  }
  .search-bar .s-icon { color: var(--muted); font-size: 15px; }
  .user-btn {
    display: flex; align-items: center; gap: 10px;
    background: var(--panel2); border: 1px solid var(--border);
    border-radius: 10px; padding: 7px 14px;
    cursor: pointer; transition: all 0.2s; color: var(--text);
    font-family: 'DM Sans', sans-serif; font-size: 14px;
  }
  .user-btn:hover { border-color: var(--accent); }
  .user-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700;
  }
  .logout-btn {
    background: none; border: 1px solid var(--border);
    border-radius: 9px; padding: 7px 14px;
    color: var(--muted); cursor: pointer; font-size: 13px;
    font-family: 'DM Sans', sans-serif; transition: all 0.2s;
  }
  .logout-btn:hover { border-color: var(--red); color: var(--red); }

  /* LAYOUT */
  .app-layout { display: flex; min-height: calc(100vh - 64px); }

  /* SIDEBAR */
  .sidebar {
    width: 240px; flex-shrink: 0;
    background: var(--panel);
    border-right: 1px solid var(--border);
    padding: 24px 16px;
    position: sticky; top: 64px;
    height: calc(100vh - 64px);
    overflow-y: auto;
    transition: transform 0.3s;
  }
  .sidebar-section { margin-bottom: 28px; }
  .sidebar-label {
    font-size: 10px; font-weight: 600; letter-spacing: 1.5px;
    text-transform: uppercase; color: var(--muted);
    margin-bottom: 10px; padding: 0 8px;
  }
  .sidebar-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px; border-radius: 10px;
    cursor: pointer; transition: all 0.18s;
    color: var(--muted); font-size: 14px; font-weight: 500;
    border: 1px solid transparent;
  }
  .sidebar-item:hover { background: var(--panel2); color: var(--text); }
  .sidebar-item.active { background: rgba(79,140,255,0.12); color: var(--accent); border-color: rgba(79,140,255,0.2); }
  .sidebar-item .s-ico { width: 20px; text-align: center; font-size: 16px; }
  .sidebar-item .s-badge {
    margin-left: auto; font-size: 10px; font-weight: 700;
    background: var(--accent); color: #fff;
    padding: 2px 7px; border-radius: 99px;
  }

  /* Storage bar */
  .storage-widget {
    background: var(--panel2); border: 1px solid var(--border);
    border-radius: 14px; padding: 16px;
    margin-top: auto;
  }
  .storage-widget .sw-title { font-size: 12px; color: var(--muted); margin-bottom: 10px; }
  .storage-bar-bg {
    height: 6px; background: var(--border); border-radius: 99px;
    margin-bottom: 8px; overflow: hidden;
  }
  .storage-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 99px;
    transition: width 1s ease;
  }
  .storage-widget .sw-nums { font-size: 12px; display: flex; justify-content: space-between; }
  .storage-widget .sw-used { color: var(--text); font-weight: 600; }
  .storage-widget .sw-total { color: var(--muted); }

  /* MAIN */
  .main { flex: 1; padding: 28px 32px; overflow-y: auto; }

  /* Upload zone */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    margin-bottom: 32px;
    transition: all 0.25s;
    cursor: pointer;
    position: relative;
  }
  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--accent);
    background: rgba(79,140,255,0.04);
  }
  .upload-zone .uz-icon { font-size: 42px; margin-bottom: 12px; }
  .upload-zone .uz-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; margin-bottom: 6px; }
  .upload-zone .uz-sub { color: var(--muted); font-size: 13px; margin-bottom: 20px; }
  .upload-zone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .uz-btn {
    display: inline-block; padding: 10px 24px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px; color: #fff;
    font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700;
    pointer-events: none;
  }

  /* Stats */
  .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }
  .stat-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 16px; padding: 20px;
    transition: all 0.25s;
  }
  .stat-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--glow); }
  .stat-card .sc-icon { font-size: 28px; margin-bottom: 10px; }
  .stat-card .sc-num { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800; margin-bottom: 4px; }
  .stat-card .sc-label { font-size: 12px; color: var(--muted); }

  /* File grid */
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 20px;
  }
  .section-header h2 { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; }
  .view-toggle { display: flex; gap: 4px; }
  .view-toggle button {
    background: var(--panel2); border: 1px solid var(--border);
    border-radius: 8px; padding: 7px 10px;
    color: var(--muted); cursor: pointer; transition: all 0.2s; font-size: 15px;
  }
  .view-toggle button.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  .filter-bar { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
  .filter-btn {
    padding: 7px 16px; border-radius: 99px;
    background: var(--panel2); border: 1px solid var(--border);
    color: var(--muted); font-size: 13px; cursor: pointer;
    transition: all 0.2s; font-family: 'DM Sans', sans-serif;
  }
  .filter-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  .file-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px;
  }
  .file-grid.list-view {
    grid-template-columns: 1fr;
    gap: 8px;
  }
  .file-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 16px; padding: 20px;
    cursor: pointer; transition: all 0.22s;
    position: relative;
    animation: fadeInCard 0.4s ease both;
  }
  @keyframes fadeInCard {
    from { opacity: 0; transform: scale(0.95); }
    to   { opacity: 1; transform: scale(1); }
  }
  .file-card:hover { border-color: var(--accent); box-shadow: 0 4px 24px rgba(79,140,255,0.15); transform: translateY(-2px); }
  .file-card .fc-icon { font-size: 40px; margin-bottom: 12px; display: block; }
  .file-card .fc-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
  .file-card .fc-meta { font-size: 11px; color: var(--muted); }
  .file-card .fc-actions {
    position: absolute; top: 10px; right: 10px;
    display: none; gap: 4px;
  }
  .file-card:hover .fc-actions { display: flex; }
  .fc-action-btn {
    width: 28px; height: 28px; border-radius: 7px;
    background: var(--panel2); border: 1px solid var(--border);
    color: var(--text); cursor: pointer; font-size: 13px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .fc-action-btn:hover { background: var(--red); border-color: var(--red); color: #fff; }
  .fc-action-btn.dl:hover { background: var(--green); border-color: var(--green); }

  /* List view card */
  .file-grid.list-view .file-card {
    display: flex; align-items: center; gap: 16px;
    padding: 14px 20px; border-radius: 12px;
  }
  .file-grid.list-view .file-card .fc-icon { font-size: 28px; margin: 0; flex-shrink: 0; }
  .file-grid.list-view .file-card .fc-info { flex: 1; min-width: 0; }
  .file-grid.list-view .file-card .fc-name { margin: 0 0 2px; }
  .file-grid.list-view .file-card .fc-actions { position: static; display: flex; margin-left: auto; }

  .empty-state {
    text-align: center; padding: 80px 20px;
    color: var(--muted); display: none;
  }
  .empty-state .es-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.4; }
  .empty-state p { font-size: 16px; }

  /* TOAST */
  .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 999; display: flex; flex-direction: column; gap: 10px; }
  .toast {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px; padding: 14px 20px;
    display: flex; align-items: center; gap: 12px;
    font-size: 14px; min-width: 260px;
    animation: toastIn 0.35s ease;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  @keyframes toastIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
  .toast.success { border-color: rgba(34,211,165,0.4); }
  .toast.error   { border-color: rgba(255,79,106,0.4); }
  .toast .t-icon { font-size: 18px; }

  /* ===== MEDIA VIEWER MODAL ===== */
  #viewer-modal {
    position: fixed; inset: 0; z-index: 1000;
    background: rgba(0,0,0,0.92);
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(10px);
    animation: fadeModal 0.2s ease;
  }
  @keyframes fadeModal { from { opacity:0; } to { opacity:1; } }
  #viewer-modal.open { display: flex; }
  .viewer-box {
    position: relative;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 20px;
    max-width: 92vw;
    max-height: 92vh;
    display: flex; flex-direction: column; gap: 14px;
    box-shadow: 0 40px 80px rgba(0,0,0,0.8);
    animation: slideUpModal 0.3s cubic-bezier(.22,1,.36,1);
  }
  @keyframes slideUpModal {
    from { opacity:0; transform: translateY(30px) scale(0.97); }
    to { opacity:1; transform: translateY(0) scale(1); }
  }
  .viewer-header {
    display: flex; align-items: center; gap: 12px;
  }
  .viewer-title {
    flex: 1; font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .viewer-close {
    width: 34px; height: 34px; border-radius: 9px;
    background: var(--panel2); border: 1px solid var(--border);
    color: var(--text); cursor: pointer; font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.15s;
  }
  .viewer-close:hover { background: var(--red); border-color: var(--red); }
  .viewer-content {
    display: flex; align-items: center; justify-content: center;
    min-width: 300px; min-height: 200px; overflow: hidden;
    border-radius: 12px; background: #000;
    position: relative;
  }
  .viewer-content img {
    max-width: 80vw; max-height: 75vh;
    border-radius: 10px; object-fit: contain; display: block;
  }
  .viewer-content video {
    max-width: 80vw; max-height: 75vh;
    border-radius: 10px; outline: none; display: block;
  }
  .viewer-content audio {
    width: 400px; max-width: 80vw;
  }
  /* Music player UI */
  .music-player {
    padding: 30px 20px; text-align: center;
    width: 360px; max-width: 80vw;
    background: var(--panel2); border-radius: 12px;
  }
  .music-player .mp-art {
    width: 120px; height: 120px; border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex; align-items: center; justify-content: center;
    font-size: 52px; margin: 0 auto 20px;
    animation: spin 10s linear infinite;
    animation-play-state: paused;
  }
  .music-player .mp-art.playing { animation-play-state: running; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .music-player audio {
    width: 100%; margin-top: 16px;
    border-radius: 8px; background: var(--panel);
  }
  .viewer-footer { display: flex; gap: 10px; justify-content: flex-end; }
  .viewer-dl-btn {
    padding: 9px 20px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none; color: #fff; font-family: 'Syne', sans-serif;
    font-size: 13px; font-weight: 700; cursor: pointer;
    transition: all 0.2s;
  }
  .viewer-dl-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(79,140,255,0.4); }
  
  /* Video player wrapper */
  .video-wrapper {
    position: relative;
    background: #000; border-radius: 10px; overflow: hidden;
  }
  .video-wrapper video {
    display: block;
  }

  /* MOBILE MENU */
  .mobile-menu-btn {
    display: none; background: none; border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); padding: 7px 10px;
    cursor: pointer; font-size: 18px;
  }
  .sidebar-overlay { display: none; }

  /* PROGRESS BAR */
  .upload-progress {
    position: fixed; bottom: 24px; left: 24px; z-index: 999;
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 16px; padding: 20px; width: 300px;
    display: none; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  .up-title { font-size: 13px; font-weight: 600; margin-bottom: 10px; }
  .up-bar-bg { height: 6px; background: var(--border); border-radius: 99px; overflow: hidden; }
  .up-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--green));
    border-radius: 99px; width: 0%;
    transition: width 0.3s;
  }
  .up-text { font-size: 11px; color: var(--muted); margin-top: 6px; }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 900px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .search-bar { width: 180px; }
    .search-bar:focus-within { width: 200px; }
  }
  @media (max-width: 700px) {
    .mobile-menu-btn { display: block; }
    .sidebar {
      position: fixed; left: 0; top: 64px; z-index: 200;
      transform: translateX(-100%);
      height: calc(100vh - 64px);
    }
    .sidebar.open { transform: translateX(0); }
    .sidebar-overlay {
      display: block; position: fixed; inset: 0; top: 64px;
      background: rgba(0,0,0,0.6); z-index: 199; display: none;
    }
    .sidebar-overlay.show { display: block; }
    .search-bar { display: none; }
    .main { padding: 20px 16px; }
    .stats-row { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .upload-zone { padding: 28px 16px; }
    .file-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
    .header { padding: 0 16px; }
    .upload-progress { left: 16px; right: 16px; width: auto; bottom: 16px; }
    .toast-container { bottom: 16px; right: 16px; left: 16px; }
    .toast { min-width: unset; }
  }
  @media (max-width: 400px) {
    .auth-card { padding: 32px 24px; }
    .stats-row { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<!-- PARTICLES -->
<div id="particles"></div>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-container">
    <div class="auth-card">
      <div class="auth-logo">
        <div class="auth-logo-icon">‚òÅÔ∏è</div>
        <div class="auth-logo-text">Nube<span>Local</span></div>
      </div>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchTab('login')">Iniciar Sesi√≥n</button>
        <button class="auth-tab" onclick="switchTab('register')">Registrarse</button>
      </div>

      <div id="auth-error" class="auth-error"></div>

      <!-- LOGIN -->
      <div id="form-login">
        <div class="form-group">
          <label>Correo Electr√≥nico</label>
          <span class="icon">‚úâÔ∏è</span>
          <input type="email" id="login-email" placeholder="tu@email.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label>Contrase√±a</label>
          <span class="icon">üîí</span>
          <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          <button class="toggle-pass" onclick="togglePass('login-pass',this)" type="button">üëÅÔ∏è</button>
        </div>
        <button class="auth-btn" onclick="handleLogin(event)">Entrar a mi Nube</button>
        <div style="text-align:center;margin-top:14px;">
          <button onclick="showForgot()" type="button" style="background:none;border:none;color:var(--muted);font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;text-decoration:underline;text-underline-offset:3px;">¬øOlvidaste tu contrase√±a?</button>
        </div>
      </div>

      <!-- FORGOT PASSWORD -->
      <div id="form-forgot" style="display:none">
        <div style="margin-bottom:18px;">
          <p style="font-size:14px;color:var(--muted);line-height:1.6;">Ingresa tu correo y tu nueva contrase√±a. <strong style="color:var(--accent)">Tus archivos se conservar√°n</strong>, solo se cambiar√° tu contrase√±a.</p>
        </div>
        <div class="form-group">
          <label>Correo Electr√≥nico</label>
          <span class="icon">‚úâÔ∏è</span>
          <input type="email" id="forgot-email" placeholder="tu@email.com">
        </div>
        <div id="forgot-confirm-box" style="display:none;background:rgba(79,140,255,0.08);border:1px solid rgba(79,140,255,0.3);border-radius:12px;padding:14px;margin-bottom:16px;">
          <p style="font-size:13px;color:var(--accent);margin-bottom:12px;">üîê Cuenta encontrada: <strong id="forgot-user-name"></strong>. Define tu nueva contrase√±a.</p>
          <div class="form-group" style="margin-bottom:10px;">
            <label>Nueva Contrase√±a</label>
            <span class="icon">üîí</span>
            <input type="password" id="new-pass" placeholder="M√≠nimo 8 caracteres" autocomplete="new-password">
          </div>
          <div class="form-group" style="margin-bottom:10px;">
            <label>Confirmar Nueva Contrase√±a</label>
            <span class="icon">üîí</span>
            <input type="password" id="new-pass2" placeholder="Repite la contrase√±a" autocomplete="new-password">
          </div>
          <button onclick="confirmReset()" style="width:100%;padding:11px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#fff;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;">‚úÖ Cambiar Contrase√±a</button>
        </div>
        <button class="auth-btn" onclick="handleForgot()" id="forgot-btn">Buscar mi cuenta</button>
        <div style="text-align:center;margin-top:14px;">
          <button onclick="hideForgot()" type="button" style="background:none;border:none;color:var(--muted);font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;">‚Üê Volver al inicio de sesi√≥n</button>
        </div>
      </div>

      <!-- REGISTER -->
      <div id="form-register" style="display:none">
        <div class="form-group">
          <label>Nombre de usuario</label>
          <span class="icon">üë§</span>
          <input type="text" id="reg-name" placeholder="Tu nombre">
        </div>
        <div class="form-group">
          <label>Correo Electr√≥nico</label>
          <span class="icon">‚úâÔ∏è</span>
          <input type="email" id="reg-email" placeholder="tu@email.com">
        </div>
        <div class="form-group">
          <label>Contrase√±a</label>
          <span class="icon">üîí</span>
          <input type="password" id="reg-pass" placeholder="M√≠nimo 8 caracteres" oninput="checkStrength(this.value)" autocomplete="new-password">
          <button class="toggle-pass" onclick="togglePass('reg-pass',this)" type="button">üëÅÔ∏è</button>
          <div class="strength-bar" id="strength-bar">
            <div id="s1"></div><div id="s2"></div><div id="s3"></div><div id="s4"></div>
          </div>
        </div>
        <div class="form-group">
          <label>Confirmar Contrase√±a</label>
          <span class="icon">üîí</span>
          <input type="password" id="reg-pass2" placeholder="Repite la contrase√±a" autocomplete="new-password">
        </div>
        <button class="auth-btn" onclick="handleRegister(event)">Crear mi Cuenta</button>
      </div>
    </div>
  </div>
</div>

<!-- APP SCREEN -->
<div id="app-screen">

  <header class="header">
    <div style="display:flex;align-items:center;gap:12px">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <div class="header-logo">
        <div class="header-logo-icon">‚òÅÔ∏è</div>
        Nube<span>local</span>
      </div>
    </div>
    <div class="search-bar">
      <span class="s-icon">üîç</span>
      <input type="text" placeholder="Buscar archivos..." oninput="searchFiles(this.value)">
    </div>
    <div class="header-right">
      <div class="user-btn">
        <div class="user-avatar" id="user-avatar-text">U</div>
        <span id="user-display-name">Usuario</span>
      </div>
      <button class="logout-btn" onclick="handleLogout()">Salir</button>
    </div>
  </header>

  <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div class="app-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-label">Navegaci√≥n</div>
        <div class="sidebar-item active" onclick="filterType('all',this)">
          <span class="s-ico">üè†</span> Todo
        </div>
        <div class="sidebar-item" onclick="filterType('image',this)">
          <span class="s-ico">üñºÔ∏è</span> Im√°genes
        </div>
        <div class="sidebar-item" onclick="filterType('video',this)">
          <span class="s-ico">üé¨</span> Videos
        </div>
        <div class="sidebar-item" onclick="filterType('audio',this)">
          <span class="s-ico">üéµ</span> M√∫sica
        </div>
        <div class="sidebar-item" onclick="filterType('document',this)">
          <span class="s-ico">üìÑ</span> Documentos
        </div>
        <div class="sidebar-item" onclick="filterType('other',this)">
          <span class="s-ico">üì¶</span> Otros
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-label">Acciones</div>
        <div class="sidebar-item" onclick="document.getElementById('file-input').click()">
          <span class="s-ico">‚¨ÜÔ∏è</span> Subir archivo
        </div>
        <div class="sidebar-item" onclick="confirmClearAll()">
          <span class="s-ico">üóëÔ∏è</span> Vaciar nube
        </div>
      </div>

      <div style="flex:1"></div>

      <div class="storage-widget">
        <div class="sw-title">‚òÅÔ∏è Almacenamiento local</div>
        <div class="storage-bar-bg">
          <div class="storage-bar-fill" id="storage-fill" style="width:0%"></div>
        </div>
        <div class="sw-nums">
          <span class="sw-used" id="storage-used">0 MB</span>
          <span class="sw-total">Ilimitado ‚àû</span>
        </div>
      </div>
    </aside>

    <main class="main">
      <!-- Upload -->
      <div class="upload-zone" id="drop-zone"
           ondragover="e=>e.preventDefault()" ondragenter="dragEnter(event)"
           ondragleave="dragLeave(event)" ondrop="handleDrop(event)">
        <input type="file" id="file-input" multiple onchange="handleFileInput(this.files)">
        <div class="uz-icon">‚òÅÔ∏è</div>
        <div class="uz-title">Sube tus archivos</div>
        <div class="uz-sub">Arrastra y suelta aqu√≠, o haz clic para seleccionar</div>
        <div class="uz-btn">+ Seleccionar archivos</div>
      </div>

      <!-- Stats -->
      <div class="stats-row" style="grid-template-columns: repeat(5, 1fr);">
        <div class="stat-card">
          <div class="sc-icon">üñºÔ∏è</div>
          <div class="sc-num" id="count-images">0</div>
          <div class="sc-label">Im√°genes</div>
        </div>
        <div class="stat-card">
          <div class="sc-icon">üéµ</div>
          <div class="sc-num" id="count-audio">0</div>
          <div class="sc-label">M√∫sica</div>
        </div>
        <div class="stat-card">
          <div class="sc-icon">üé¨</div>
          <div class="sc-num" id="count-videos">0</div>
          <div class="sc-label">Videos</div>
        </div>
        <div class="stat-card">
          <div class="sc-icon">üìÑ</div>
          <div class="sc-num" id="count-docs">0</div>
          <div class="sc-label">Documentos</div>
        </div>
        <div class="stat-card">
          <div class="sc-icon">üì¶</div>
          <div class="sc-num" id="count-total">0</div>
          <div class="sc-label">Total archivos</div>
        </div>
      </div>

      <!-- Files -->
      <div class="section-header">
        <h2>Mis Archivos</h2>
        <div class="view-toggle">
          <button id="btn-grid" class="active" onclick="setView('grid')" title="Vista cuadr√≠cula">‚äû</button>
          <button id="btn-list" onclick="setView('list')" title="Vista lista">‚ò∞</button>
        </div>
      </div>

      <div class="filter-bar" id="filter-bar"></div>

      <div class="file-grid" id="file-grid"></div>

      <div class="empty-state" id="empty-state">
        <div class="es-icon">‚òÅÔ∏è</div>
        <p>Tu nube est√° vac√≠a. ¬°Sube algunos archivos!</p>
      </div>
    </main>
  </div>
</div>

<!-- UPLOAD PROGRESS -->
<div class="upload-progress" id="upload-progress">
  <div class="up-title">‚¨ÜÔ∏è Subiendo archivo...</div>
  <div class="up-bar-bg"><div class="up-bar-fill" id="up-fill"></div></div>
  <div class="up-text" id="up-text">Preparando...</div>
</div>

<!-- MEDIA VIEWER MODAL -->
<div id="viewer-modal">
  <div class="viewer-box" id="viewer-box">
    <div class="viewer-header">
      <span id="viewer-file-icon" style="font-size:22px;flex-shrink:0"></span>
      <div class="viewer-title" id="viewer-title"></div>
      <button class="viewer-close" onclick="closeViewer()">‚úï</button>
    </div>
    <div class="viewer-content" id="viewer-content"></div>
    <div class="viewer-footer">
      <button class="viewer-dl-btn" id="viewer-dl-btn">‚¨áÔ∏è Descargar</button>
    </div>
  </div>
</div>

<!-- TOASTS -->
<div class="toast-container" id="toast-container"></div>

<script>
// ============================================================
//  SECURITY & AUTH ‚Äî AES-256-GCM + PBKDF2
// ============================================================
const STORAGE_KEY = 'nubevault_users';
const SESSION_KEY = 'nubevault_session';
const FILES_KEY   = 'nubevault_files_';
const MAX_SIZE_MB  = Infinity;

// ‚îÄ‚îÄ Crypto helpers (Web Crypto API ‚Äî nativo del navegador) ‚îÄ‚îÄ

// Convierte ArrayBuffer ‚Üî Base64
function ab2b64(buf) {
  return btoa(String.fromCharCode(...new Uint8Array(buf)));
}
function b642ab(b64) {
  const bin = atob(b64);
  const buf = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
  return buf.buffer;
}

// Deriva una CryptoKey AES-256-GCM desde contrase√±a + salt usando PBKDF2
async function deriveKey(password, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']
  );
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: 310000, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

// Cifra texto con AES-256-GCM. Devuelve "{salt_b64}:{iv_b64}:{cipher_b64}"
async function encryptText(plaintext, password) {
  const salt = crypto.getRandomValues(new Uint8Array(32));
  const iv   = crypto.getRandomValues(new Uint8Array(12));
  const key  = await deriveKey(password, salt);
  const enc  = new TextEncoder();
  const cipherBuf = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(plaintext));
  return ab2b64(salt) + ':' + ab2b64(iv) + ':' + ab2b64(cipherBuf);
}

// Descifra texto cifrado con encryptText
async function decryptText(cipherStr, password) {
  const [saltB64, ivB64, cipherB64] = cipherStr.split(':');
  const salt      = b642ab(saltB64);
  const iv        = new Uint8Array(b642ab(ivB64));
  const cipherBuf = b642ab(cipherB64);
  const key = await deriveKey(password, new Uint8Array(salt));
  const plainBuf = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, cipherBuf);
  return new TextDecoder().decode(plainBuf);
}

// Hash seguro de contrase√±a para verificaci√≥n (PBKDF2-SHA256, salt fijo por usuario)
async function hashPass(password, saltHex) {
  const salt = saltHex
    ? new Uint8Array(saltHex.match(/.{2}/g).map(b => parseInt(b, 16)))
    : crypto.getRandomValues(new Uint8Array(32));
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw', enc.encode(password), 'PBKDF2', false, ['deriveBits']
  );
  const bits = await crypto.subtle.deriveBits(
    { name: 'PBKDF2', salt, iterations: 310000, hash: 'SHA-256' },
    keyMaterial, 256
  );
  const hashHex = Array.from(new Uint8Array(bits)).map(b => b.toString(16).padStart(2,'0')).join('');
  const saltHexOut = Array.from(salt).map(b => b.toString(16).padStart(2,'0')).join('');
  return { hash: hashHex, salt: saltHexOut };
}

// ‚îÄ‚îÄ Sesi√≥n en memoria (nunca toca disco) ‚îÄ‚îÄ
let _sessionKey = null;   // CryptoKey AES ef√≠mera de sesi√≥n (solo en RAM)
let _sessionPass = null;  // Contrase√±a en RAM durante la sesi√≥n activa

function getUsers() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; }
}
function saveUsers(u) { localStorage.setItem(STORAGE_KEY, JSON.stringify(u)); }
function getSession() {
  try { return JSON.parse(sessionStorage.getItem(SESSION_KEY)); } catch { return null; }
}
function setSession(user) { sessionStorage.setItem(SESSION_KEY, JSON.stringify(user)); }
function clearSession() {
  sessionStorage.removeItem(SESSION_KEY);
  _sessionPass = null;
  _sessionKey  = null;
}

function validateEmail(e) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
function validatePass(p) { return p.length >= 8; }

// Rate limiting (5 intentos / 60s)
const failCounts = {};
const failTimes  = {};
function checkRateLimit(email) {
  const now = Date.now();
  if (failTimes[email] && now - failTimes[email] > 60000) { failCounts[email] = 0; }
  return (failCounts[email] || 0) < 5;
}
function recordFail(email) {
  failCounts[email] = (failCounts[email] || 0) + 1;
  failTimes[email]  = Date.now();
}

// XSS sanitize
function sanitize(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// ============================================================
//  AUTH UI
// ============================================================
let activeTab = 'login';

function switchTab(tab) {
  activeTab = tab;
  document.getElementById('form-login').style.display    = tab === 'login'    ? '' : 'none';
  document.getElementById('form-register').style.display = tab === 'register' ? '' : 'none';
  document.getElementById('form-forgot').style.display   = 'none';
  document.getElementById('auth-tabs').style.display     = '';
  document.querySelectorAll('.auth-tab').forEach((b,i) => b.classList.toggle('active', (i===0 && tab==='login')||(i===1 && tab==='register')));
  hideError();
}

function showError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.style.display = 'block';
  el.style.animation = 'none';
  setTimeout(() => el.style.animation = '', 10);
}
function hideError() {
  const el = document.getElementById('auth-error');
  el.style.display = 'none';
  el.style.background = 'rgba(255,79,106,0.1)';
  el.style.borderColor = 'rgba(255,79,106,0.3)';
  el.style.color = 'var(--red)';
}

function togglePass(id, btn) {
  const inp = document.getElementById(id);
  if (inp.type === 'password') { inp.type = 'text'; btn.textContent = 'üôà'; }
  else { inp.type = 'password'; btn.textContent = 'üëÅÔ∏è'; }
}

function checkStrength(val) {
  const colors = [null, '#ff4f6a', '#ffc84a', '#4f8cff', '#22d3a5'];
  let score = 0;
  if (val.length >= 8) score++;
  if (/[A-Z]/.test(val)) score++;
  if (/[0-9]/.test(val)) score++;
  if (/[^A-Za-z0-9]/.test(val)) score++;
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('s' + i);
    el.style.background = i <= score ? colors[score] : 'var(--border)';
  }
}

function addRipple(e, btn) {
  const rect = btn.getBoundingClientRect();
  const r = document.createElement('span');
  r.className = 'btn-ripple';
  r.style.cssText = `width:60px;height:60px;left:${e.clientX-rect.left-30}px;top:${e.clientY-rect.top-30}px`;
  btn.appendChild(r);
  setTimeout(() => r.remove(), 700);
}

function setBtnLoading(btnId, loading, originalText) {
  const btn = document.getElementById(btnId) || document.querySelector('.auth-btn');
  if (!btn) return;
  if (loading) {
    btn.disabled = true;
    btn.dataset.orig = btn.textContent;
    btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Procesando...</span>';
  } else {
    btn.disabled = false;
    btn.textContent = btn.dataset.orig || originalText || 'Continuar';
  }
}

// ============================================================
//  FORGOT PASSWORD (async)
// ============================================================
function showForgot() {
  document.getElementById('form-login').style.display    = 'none';
  document.getElementById('form-register').style.display = 'none';
  document.getElementById('form-forgot').style.display   = '';
  document.getElementById('auth-tabs').style.display     = 'none';
  document.getElementById('forgot-email').value          = '';
  document.getElementById('forgot-confirm-box').style.display = 'none';
  document.getElementById('forgot-btn').style.display    = '';
  hideError();
}

function hideForgot() { switchTab('login'); }

function handleForgot() {
  hideError();
  const email = document.getElementById('forgot-email').value.trim().toLowerCase();
  if (!email) { showError('Ingresa tu correo electr√≥nico.'); return; }
  if (!validateEmail(email)) { showError('Correo electr√≥nico inv√°lido.'); return; }
  const users = getUsers();
  if (!users[email]) { showError('No encontramos una cuenta con ese correo.'); return; }
  document.getElementById('forgot-user-name').textContent = users[email].name;
  document.getElementById('forgot-confirm-box').style.display = 'block';
  document.getElementById('forgot-btn').style.display = 'none';
  document.getElementById('new-pass').value = '';
  document.getElementById('new-pass2').value = '';
}

async function confirmReset() {
  const email    = document.getElementById('forgot-email').value.trim().toLowerCase();
  const newPass  = document.getElementById('new-pass').value;
  const newPass2 = document.getElementById('new-pass2').value;
  if (!newPass || !newPass2) { showError('Ingresa tu nueva contrase√±a.'); return; }
  if (!validatePass(newPass)) { showError('La contrase√±a debe tener al menos 8 caracteres.'); return; }
  if (newPass !== newPass2) { showError('Las contrase√±as no coinciden.'); return; }
  const users = getUsers();
  if (!users[email]) { showError('Cuenta no encontrada.'); return; }

  // ‚ö†Ô∏è ADVERTENCIA: cambiar contrase√±a re-cifra todos los archivos con la nueva clave
  const confirmEl = document.querySelector('#forgot-confirm-box button');
  if (confirmEl) { confirmEl.disabled = true; confirmEl.textContent = 'üîê Re-cifrando archivos...'; }

  try {
    // Actualizar hash con PBKDF2 ‚Äî los archivos cifrados con la contrase√±a anterior se eliminan
    // ya que sin la contrase√±a vieja no se pueden re-cifrar
    const filesRaw = localStorage.getItem(FILES_KEY + email);
    if (filesRaw && users[email].encrypted) {
      // Advertir y limpiar archivos cifrados con contrase√±a anterior
      localStorage.removeItem(FILES_KEY + email);
    }
    const { hash, salt } = await hashPass(newPass);
    users[email].passHash  = hash;
    users[email].passSalt  = salt;
    users[email].encrypted = true;
    saveUsers(users);
  } catch(e) {
    showError('Error al actualizar la contrase√±a. Intenta de nuevo.');
    if (confirmEl) { confirmEl.disabled = false; confirmEl.textContent = '‚úÖ Cambiar Contrase√±a'; }
    return;
  }

  switchTab('login');
  document.getElementById('login-email').value = email;
  const errEl = document.getElementById('auth-error');
  errEl.textContent   = '‚úÖ Contrase√±a cambiada con AES-256. Nota: archivos anteriores eliminados por seguridad.';
  errEl.style.display = 'block';
  errEl.style.background  = 'rgba(34,211,165,0.1)';
  errEl.style.borderColor = 'rgba(34,211,165,0.3)';
  errEl.style.color       = 'var(--green)';
}

// ============================================================
//  AUTH HANDLERS (async ‚Äî PBKDF2 + AES-256-GCM)
// ============================================================
async function handleLogin(e) {
  addRipple(e, e.currentTarget);
  hideError();
  const btn   = e.currentTarget;
  const email = document.getElementById('login-email').value.trim().toLowerCase();
  const pass  = document.getElementById('login-pass').value;

  if (!email || !pass) { showError('Por favor completa todos los campos.'); return; }
  if (!validateEmail(email)) { showError('Correo electr√≥nico inv√°lido.'); return; }
  if (!checkRateLimit(email)) { showError('Demasiados intentos. Espera 60 segundos.'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:8px">üîê Verificando...</span>';

  try {
    const users = getUsers();
    const user  = users[email];
    if (!user) { throw new Error('not_found'); }

    let valid = false;
    if (user.passSalt) {
      // Nuevo sistema PBKDF2
      const { hash } = await hashPass(pass, user.passSalt);
      valid = hash === user.passHash;
    } else {
      // Migraci√≥n: cuenta antigua con hash simple
      const oldHash = legacyHash(pass);
      valid = oldHash === user.passHash;
      if (valid) {
        // Migrar a PBKDF2 en el acto
        const { hash, salt } = await hashPass(pass);
        user.passHash = hash; user.passSalt = salt; user.encrypted = true;
        saveUsers(users);
      }
    }

    if (!valid) { throw new Error('wrong_pass'); }

    _sessionPass = pass;
    setSession({ email, name: user.name });
    enterApp(user.name, email);
  } catch(err) {
    recordFail(email);
    showError('Correo o contrase√±a incorrectos.');
    btn.disabled = false;
    btn.textContent = 'Entrar a mi Nube';
  }
}

async function handleRegister(e) {
  addRipple(e, e.currentTarget);
  hideError();
  const btn   = e.currentTarget;
  const name  = sanitize(document.getElementById('reg-name').value.trim());
  const email = document.getElementById('reg-email').value.trim().toLowerCase();
  const pass  = document.getElementById('reg-pass').value;
  const pass2 = document.getElementById('reg-pass2').value;

  if (!name || !email || !pass || !pass2) { showError('Completa todos los campos.'); return; }
  if (name.length < 2) { showError('El nombre debe tener al menos 2 caracteres.'); return; }
  if (!validateEmail(email)) { showError('Correo electr√≥nico inv√°lido.'); return; }
  if (!validatePass(pass)) { showError('La contrase√±a debe tener al menos 8 caracteres.'); return; }
  if (pass !== pass2) { showError('Las contrase√±as no coinciden.'); return; }

  const users = getUsers();
  if (users[email]) { showError('Ya existe una cuenta con ese correo.'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:8px">üîê Creando cuenta segura...</span>';

  try {
    const { hash, salt } = await hashPass(pass);
    users[email] = { name, passHash: hash, passSalt: salt, encrypted: true, created: Date.now() };
    saveUsers(users);
    _sessionPass = pass;
    setSession({ email, name });
    enterApp(name, email);
  } catch(err) {
    showError('Error al crear la cuenta. Intenta de nuevo.');
    btn.disabled = false;
    btn.textContent = 'Crear mi Cuenta';
  }
}

// Hash legado (solo para migrar cuentas viejas)
function legacyHash(password) {
  let hash = 0;
  for (let i = 0; i < password.length; i++) {
    const c = password.charCodeAt(i);
    hash = ((hash << 5) - hash) + c;
    hash |= 0;
  }
  return hash.toString(36) + password.length + 'sv';
}

// ============================================================
//  APP
// ============================================================
let currentUser = null;
let allFiles    = [];
let currentFilter = 'all';
let viewMode = 'grid';

async function enterApp(name, email) {
  currentUser = { name, email };
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app-screen').style.display  = 'block';
  document.getElementById('user-display-name').textContent = name;
  document.getElementById('user-avatar-text').textContent  = name[0].toUpperCase();
  // Show security badge
  const users = getUsers();
  const isEncrypted = users[email] && users[email].encrypted;
  showSecurityBadge(isEncrypted);
  await loadFiles();
  updateStats();
}

function handleLogout() {
  clearSession();
  _sessionPass = null;
  currentUser = null;
  allFiles    = [];
  document.getElementById('app-screen').style.display  = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('login-email').value = '';
  document.getElementById('login-pass').value  = '';
  switchTab('login');
}

function showSecurityBadge(encrypted) {
  const existing = document.getElementById('sec-badge');
  if (existing) existing.remove();
  const badge = document.createElement('div');
  badge.id = 'sec-badge';
  badge.style.cssText = `
    display:inline-flex;align-items:center;gap:6px;
    padding:5px 12px;border-radius:99px;font-size:12px;font-weight:600;
    font-family:'DM Sans',sans-serif;
    background:${encrypted ? 'rgba(34,211,165,0.12)' : 'rgba(255,196,74,0.12)'};
    border:1px solid ${encrypted ? 'rgba(34,211,165,0.35)' : 'rgba(255,196,74,0.35)'};
    color:${encrypted ? 'var(--green)' : 'var(--yellow)'};
  `;
  badge.innerHTML = encrypted
    ? 'üîê AES-256 Cifrado'
    : '‚ö†Ô∏è Sin cifrado';
  const headerRight = document.querySelector('.header-right');
  if (headerRight) headerRight.insertBefore(badge, headerRight.firstChild);
}

// Auto-login session
window.addEventListener('DOMContentLoaded', () => {
  createParticles();
  const session = getSession();
  if (session) {
    // Si hay sesi√≥n activa pero no hay contrase√±a en RAM, pedir login de nuevo para cifrado
    if (!_sessionPass) {
      // Forzar re-login para poder descifrar los archivos con AES
      clearSession();
      switchTab('login');
    } else {
      enterApp(session.name, session.email);
    }
  }
});

// ============================================================
//  FILES
// ============================================================
function filesKey() { return FILES_KEY + currentUser.email; }

async function loadFiles() {
  try {
    const raw = localStorage.getItem(filesKey());
    if (!raw) { allFiles = []; }
    else {
      const users = getUsers();
      const user  = users[currentUser.email];
      if (user && user.encrypted && _sessionPass && raw.includes(':')) {
        // Descifrar con AES-256-GCM
        try {
          const decrypted = await decryptText(raw, _sessionPass);
          allFiles = JSON.parse(decrypted) || [];
        } catch(e) {
          // Fall√≥ el descifrado ‚Äî posible contrase√±a incorrecta o datos corruptos
          allFiles = [];
          showToast('‚ö†Ô∏è Error al descifrar archivos', 'error');
        }
      } else {
        // Datos no cifrados (cuentas legacy) ‚Äî cargar tal cual
        allFiles = JSON.parse(raw) || [];
      }
    }
  } catch { allFiles = []; }
  renderFiles();
  updateStats();
  updateStorage();
}

async function saveFiles() {
  try {
    const users = getUsers();
    const user  = users[currentUser.email];
    const json  = JSON.stringify(allFiles);
    if (user && user.encrypted && _sessionPass) {
      // Cifrar con AES-256-GCM antes de guardar
      const encrypted = await encryptText(json, _sessionPass);
      localStorage.setItem(filesKey(), encrypted);
    } else {
      localStorage.setItem(filesKey(), json);
    }
  } catch(e) {
    showToast('‚ùå Error al guardar archivos cifrados', 'error');
  }
  updateStats();
  updateStorage();
}

function getFileType(name) {
  const ext = name.split('.').pop().toLowerCase();
  if (['jpg','jpeg','png','gif','webp','svg','bmp','avif','tiff','ico'].includes(ext)) return 'image';
  if (['mp3','wav','ogg','flac','aac','m4a','opus','wma','aiff','ape','mid','midi'].includes(ext)) return 'audio';
  if (['mp4','avi','mov','mkv','webm','flv','wmv','m4v','3gp','ts','mpeg','mpg','ogv','vob'].includes(ext)) return 'video';
  if (['pdf','doc','docx','txt','xls','xlsx','ppt','pptx','csv','rtf','odt','ods','odp'].includes(ext)) return 'document';
  return 'other';
}

function getFileIcon(type, name) {
  const ext = name.split('.').pop().toLowerCase();
  const icons = {
    image: 'üñºÔ∏è', audio: 'üéµ', video: 'üé¨',
    pdf: 'üìï', doc: 'üìò', docx: 'üìò',
    txt: 'üìÑ', xls: 'üìó', xlsx: 'üìó',
    ppt: 'üìô', pptx: 'üìô', csv: 'üìä',
    zip: 'üóúÔ∏è', rar: 'üóúÔ∏è',
  };
  return icons[ext] || icons[type] || 'üì¶';
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/(1024*1024)).toFixed(1) + ' MB';
}

function formatDate(ts) {
  return new Date(ts).toLocaleDateString('es', { day:'2-digit', month:'short', year:'numeric' });
}

// File input
function handleFileInput(fileList) {
  uploadFiles(Array.from(fileList));
}

function handleDrop(e) {
  e.preventDefault();
  dragLeave(e);
  uploadFiles(Array.from(e.dataTransfer.files));
}
function dragEnter(e) { e.preventDefault(); document.getElementById('drop-zone').classList.add('drag-over'); }
function dragLeave(e) { document.getElementById('drop-zone').classList.remove('drag-over'); }

function uploadFiles(files) {
  if (!files.length) return;
  let idx = 0;

  function next() {
    if (idx >= files.length) {
      hideProgress();
      saveFiles().then(() => {
        renderFiles();
        showToast(`üîê ${files.length} archivo(s) cifrado(s) y guardado(s)`, 'success');
        document.getElementById('file-input').value = '';
      });
      return;
    }
    const file = files[idx++];
    showProgress(file.name);

    const reader = new FileReader();
    reader.onprogress = (ev) => {
      if (ev.lengthComputable) updateProgress((ev.loaded/ev.total)*100, file.name);
    };
    reader.onload = (ev) => {
      updateProgress(100, file.name);
      const entry = {
        id:   Date.now() + Math.random().toString(36).slice(2),
        name: sanitize(file.name),
        type: getFileType(file.name),
        size: file.size,
        date: Date.now(),
        data: ev.target.result
      };
      allFiles.push(entry);
      setTimeout(next, 300);
    };
    reader.onerror = () => { showToast(`‚ùå Error al leer "${file.name}"`, 'error'); next(); };
    reader.readAsDataURL(file);
  }
  next();
}

async function deleteFile(id) {
  allFiles = allFiles.filter(f => f.id !== id);
  await saveFiles();
  renderFiles();
  showToast('üóëÔ∏è Archivo eliminado', 'success');
}

function downloadFile(id) {
  const f = allFiles.find(x => x.id === id);
  if (!f) return;
  const a = document.createElement('a');
  a.href = f.data; a.download = f.name;
  a.click();
  showToast('‚¨áÔ∏è Descargando: ' + f.name, 'success');
}

async function confirmClearAll() {
  if (allFiles.length === 0) { showToast('La nube ya est√° vac√≠a', 'error'); return; }
  if (confirm('¬øSeguro que quieres eliminar TODOS los archivos?')) {
    allFiles = [];
    await saveFiles();
    renderFiles();
    showToast('üóëÔ∏è Nube vaciada', 'success');
  }
}

// ============================================================
//  RENDER
// ============================================================
let searchQuery = '';

function searchFiles(q) {
  searchQuery = q.toLowerCase();
  renderFiles();
}

function setView(mode) {
  viewMode = mode;
  document.getElementById('btn-grid').classList.toggle('active', mode === 'grid');
  document.getElementById('btn-list').classList.toggle('active', mode === 'list');
  const grid = document.getElementById('file-grid');
  grid.classList.toggle('list-view', mode === 'list');
}

function filterType(type, el) {
  currentFilter = type;
  document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  renderFiles();
}

function renderFiles() {
  const grid = document.getElementById('file-grid');
  const empty = document.getElementById('empty-state');

  let files = allFiles;
  if (currentFilter !== 'all') files = files.filter(f => f.type === currentFilter);
  if (searchQuery) files = files.filter(f => f.name.toLowerCase().includes(searchQuery));

  // Sort newest first
  files = files.sort((a,b) => b.date - a.date);

  grid.innerHTML = '';
  if (files.length === 0) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  files.forEach((f, i) => {
    const card = document.createElement('div');
    card.className = 'file-card';
    card.style.animationDelay = (i * 0.04) + 's';

    const isImage = f.type === 'image';
    const iconContent = isImage
      ? `<img src="${f.data}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;margin-bottom:10px;display:block;" loading="lazy" alt="${f.name}">`
      : `<span class="fc-icon">${getFileIcon(f.type, f.name)}</span>`;

    if (viewMode === 'list') {
      card.innerHTML = `
        <span class="fc-icon">${getFileIcon(f.type, f.name)}</span>
        <div class="fc-info">
          <div class="fc-name" title="${f.name}">${f.name}</div>
          <div class="fc-meta">${formatSize(f.size)} ¬∑ ${formatDate(f.date)}</div>
        </div>
        <div class="fc-actions">
          <button class="fc-action-btn dl" onclick="event.stopPropagation();downloadFile('${f.id}')" title="Descargar">‚¨áÔ∏è</button>
          <button class="fc-action-btn"    onclick="event.stopPropagation();deleteFile('${f.id}')"   title="Eliminar">üóëÔ∏è</button>
        </div>`;
    } else {
      card.innerHTML = `
        ${iconContent}
        <div class="fc-name" title="${f.name}">${f.name}</div>
        <div class="fc-meta">${formatSize(f.size)} ¬∑ ${formatDate(f.date)}</div>
        <div class="fc-actions">
          <button class="fc-action-btn dl" onclick="event.stopPropagation();downloadFile('${f.id}')" title="Descargar">‚¨áÔ∏è</button>
          <button class="fc-action-btn"    onclick="event.stopPropagation();deleteFile('${f.id}')"   title="Eliminar">üóëÔ∏è</button>
        </div>`;
    }
    card.addEventListener('click', () => openViewer(f.id));
    grid.appendChild(card);
  });
}

function updateStats() {
  const counts = { image:0, audio:0, video:0, document:0 };
  allFiles.forEach(f => { if (counts[f.type] !== undefined) counts[f.type]++; });
  document.getElementById('count-images').textContent  = counts.image;
  document.getElementById('count-audio').textContent   = counts.audio;
  document.getElementById('count-videos').textContent  = counts.video;
  document.getElementById('count-docs').textContent    = counts.document;
  document.getElementById('count-total').textContent   = allFiles.length;
}

function updateStorage() {
  const totalBytes = allFiles.reduce((s,f) => s + f.size, 0);
  const mb = totalBytes / (1024*1024);
  document.getElementById('storage-fill').style.width = '0%';
  document.getElementById('storage-used').textContent = mb.toFixed(1) + ' MB';
}

// ============================================================
//  MEDIA VIEWER
// ============================================================
let currentViewerId = null;

function openViewer(id) {
  const f = allFiles.find(x => x.id === id);
  if (!f) return;
  currentViewerId = id;

  document.getElementById('viewer-title').textContent = f.name;
  document.getElementById('viewer-file-icon').textContent = getFileIcon(f.type, f.name);
  document.getElementById('viewer-dl-btn').onclick = () => downloadFile(id);

  const content = document.getElementById('viewer-content');
  content.innerHTML = '';
  content.style.background = '#000';

  if (f.type === 'image') {
    content.style.background = 'transparent';
    const img = document.createElement('img');
    img.src = f.data;
    img.alt = f.name;
    img.style.cssText = 'max-width:80vw;max-height:75vh;border-radius:10px;object-fit:contain;display:block;';
    content.appendChild(img);

  } else if (f.type === 'video') {
    const video = document.createElement('video');
    video.src = f.data;
    video.controls = true;
    video.autoplay = true;
    video.style.cssText = 'max-width:82vw;max-height:75vh;border-radius:10px;outline:none;display:block;';
    content.appendChild(video);

  } else if (f.type === 'audio') {
    content.style.background = 'var(--panel2)';
    const wrapper = document.createElement('div');
    wrapper.className = 'music-player';
    wrapper.innerHTML = `
      <div class="mp-art" id="mp-art">üéµ</div>
      <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${sanitize(f.name)}</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:12px;">${formatSize(f.size)}</div>
    `;
    const audio = document.createElement('audio');
    audio.src = f.data;
    audio.controls = true;
    audio.autoplay = true;
    audio.style.width = '100%';
    audio.addEventListener('play', () => document.getElementById('mp-art')?.classList.add('playing'));
    audio.addEventListener('pause', () => document.getElementById('mp-art')?.classList.remove('playing'));
    audio.addEventListener('ended', () => document.getElementById('mp-art')?.classList.remove('playing'));
    wrapper.appendChild(audio);
    content.appendChild(wrapper);
    content.style.background = 'transparent';

  } else {
    // Generic file preview
    content.style.background = 'var(--panel2)';
    content.style.borderRadius = '12px';
    content.innerHTML = `
      <div style="text-align:center;padding:50px 40px;">
        <div style="font-size:72px;margin-bottom:16px;">${getFileIcon(f.type, f.name)}</div>
        <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:8px;">${sanitize(f.name)}</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:24px;">${formatSize(f.size)} ¬∑ ${formatDate(f.date)}</div>
        <button onclick="downloadFile('${f.id}')" style="padding:10px 24px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#fff;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;">‚¨áÔ∏è Descargar archivo</button>
      </div>`;
  }

  const modal = document.getElementById('viewer-modal');
  modal.classList.add('open');
  modal.onclick = (e) => { if (e.target === modal) closeViewer(); };
}

function closeViewer() {
  const modal = document.getElementById('viewer-modal');
  modal.classList.remove('open');
  // Stop any media playing
  const content = document.getElementById('viewer-content');
  const video = content.querySelector('video');
  const audio = content.querySelector('audio');
  if (video) { video.pause(); video.src = ''; }
  if (audio) { audio.pause(); audio.src = ''; }
  content.innerHTML = '';
  currentViewerId = null;
}

// ESC to close viewer
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeViewer();
});

// ============================================================
//  PROGRESS
// ============================================================
function showProgress(name) {
  document.getElementById('upload-progress').style.display = 'block';
  document.getElementById('up-fill').style.width = '0%';
  document.getElementById('up-text').textContent = name;
}
function updateProgress(pct, name) {
  document.getElementById('up-fill').style.width = pct + '%';
  document.getElementById('up-text').textContent = pct < 100 ? name : '‚úÖ Completado!';
}
function hideProgress() {
  setTimeout(() => { document.getElementById('upload-progress').style.display = 'none'; }, 800);
}

// ============================================================
//  TOAST
// ============================================================
function showToast(msg, type = 'success') {
  const c  = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span class="t-icon">${type==='success'?'‚úÖ':'‚ö†Ô∏è'}</span> ${msg}`;
  c.appendChild(el);
  setTimeout(() => { el.style.opacity='0'; el.style.transform='translateX(40px)'; el.style.transition='all 0.35s'; setTimeout(()=>el.remove(),400); }, 3000);
}

// ============================================================
//  SIDEBAR TOGGLE (mobile)
// ============================================================
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebar-overlay').classList.toggle('show');
}

// ============================================================
//  PARTICLES
// ============================================================
function createParticles() {
  const container = document.getElementById('particles');
  const colors = ['#4f8cff','#a259ff','#22d3a5','#ffc84a'];
  for (let i = 0; i < 30; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const size = Math.random() * 4 + 2;
    p.style.cssText = `
      width:${size}px; height:${size}px;
      left:${Math.random()*100}%;
      background:${colors[Math.floor(Math.random()*colors.length)]};
      animation-duration:${Math.random()*12+8}s;
      animation-delay:${Math.random()*10}s;
    `;
    container.appendChild(p);
  }
}

// ============================================================
//  DRAG EVENTS on drop zone
// ============================================================
const dz = document.getElementById('drop-zone');
dz.addEventListener('dragover',  e => e.preventDefault());
dz.addEventListener('dragenter', dragEnter);
dz.addEventListener('dragleave', dragLeave);
dz.addEventListener('drop',      handleDrop);
</script>

<script>
// Register Service Worker for PWA offline support
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registrado:', reg.scope))
      .catch(err => console.log('SW error:', err));
  });
}

// PWA Install prompt (Android)
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  showInstallBanner();
});

function showInstallBanner() {
  if (document.getElementById('install-banner')) return;
  const banner = document.createElement('div');
  banner.id = 'install-banner';
  banner.style.cssText = `
    position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
    background:#111318;border:1px solid #4f8cff;border-radius:16px;
    padding:14px 20px;display:flex;align-items:center;gap:14px;
    z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,0.6);
    font-family:'DM Sans',sans-serif;font-size:14px;color:#e8eaf0;
    max-width:320px;width:90%;
  `;
  banner.innerHTML = `
    <span style="font-size:24px">‚òÅÔ∏è</span>
    <div style="flex:1">
      <div style="font-weight:600;margin-bottom:2px">Instalar NubeVault</div>
      <div style="font-size:12px;color:#6b7285">Agregar a pantalla de inicio</div>
    </div>
    <button onclick="installApp()" style="background:linear-gradient(135deg,#4f8cff,#a259ff);border:none;border-radius:10px;color:#fff;padding:8px 16px;font-family:'Syne',sans-serif;font-weight:700;font-size:13px;cursor:pointer;">Instalar</button>
    <button onclick="document.getElementById('install-banner').remove()" style="background:none;border:none;color:#6b7285;cursor:pointer;font-size:18px;padding:0 4px;">√ó</button>
  `;
  document.body.appendChild(banner);
}

async function installApp() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  const banner = document.getElementById('install-banner');
  if (banner) banner.remove();
}
</script>
</body>
</html>